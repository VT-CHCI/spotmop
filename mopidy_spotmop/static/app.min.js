/**
 * Mopidy-Spotmop
 * Built 2016-01-20
**/

angular.module("spotmop",["ngResource","ngStorage","ngTouch","ui.router","angular-loading-bar","angular-google-analytics","spotmop.directives","spotmop.common.contextmenu","spotmop.common.tracklist","spotmop.services.notify","spotmop.services.settings","spotmop.services.player","spotmop.services.spotify","spotmop.services.mopidy","spotmop.services.echonest","spotmop.services.lastfm","spotmop.services.dialog","spotmop.services.pusher","spotmop.player","spotmop.queue","spotmop.library","spotmop.search","spotmop.settings","spotmop.discover","spotmop.browse","spotmop.browse.artist","spotmop.browse.album","spotmop.browse.playlist","spotmop.browse.user","spotmop.browse.genre","spotmop.browse.featured","spotmop.browse.new"]).config(function(a,b,c,d,e){c.otherwise("queue"),d.interceptors.push("SpotifyServiceIntercepter"),e.useAnalytics(!0),e.setAccount("UA-64701652-3")}).run(function(a,b,c){}).controller("ApplicationController",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){var b=null;return $(a).hasClass("droppable")?b=$(a):$(a).closest(".droppable").length>0&&(b=$(a).closest(".droppable")),b}function q(a){var b=null;return $(a).hasClass("track")?b=$(a):$(a).closest(".track").length>0&&(b=$(a).closest(".track")),b}o.trackEvent("Spotmop","Started"),a.isTouchDevice=function(){return k.getSetting("emulateTouchDevice",!1)?!0:!!("ontouchstart"in window)},a.isSameDomainAsMopidy=function(){var a=k.getSetting("mopidyhost","localhost");return a&&"localhost"!=a?f.host()==a?!0:void 0:!0},a.state=j.state,a.currentTracklist=[],a.spotifyUser={},a.menuCollapsable=!1,a.reloadApp=function(){window.location.reload()},a.playlistsMenu=[],a.myPlaylists={},a.popupVolumeControls=function(){n.create("volumeControls",a)},a.updatePlaylists=function(){g.getPlaylists(a.spotifyUser.id,50).then(function(b){a.myPlaylists=b.items;var c=[];$.each(b.items,function(b,d){if(d.owner.id==a.spotifyUser.id){var e=d;e.link="/browse/playlist/"+d.uri,e.link="/browse/playlist/"+d.uri,c.push(e)}}),a.playlistsMenu=c})},a.windowWidth=$(document).width(),a.windowHeight=$(document).height(),a.mediumScreen=function(){return a.windowWidth<=800?!0:!1},a.smallScreen=function(){return a.windowWidth<=450?!0:!1},angular.element(window).resize(function(){$(document).width()!=a.windowWidth&&(a.windowWidth=$(document).width(),$(document).find("body").removeClass("menu-revealed"))}),b.$on("$stateChangeStart",function(b){a.hideMenu(),o.trackPage(f.path())}),$(document).on("click","#body",function(b){$(b.target).closest(".menu-reveal-trigger").length<=0&&a.hideMenu()}),a.showMenu=function(){$(document).find("body").addClass("menu-revealed")},a.hideMenu=function(){$(document).find("body").removeClass("menu-revealed")},a.searchSubmit=function(a){o.trackEvent("Search","Performed search",a);var b=g.uriType(a);b?(l.notify("You've been redirected because that looked like a Spotify URI"),"artist"==b?($(document).find(".search-form input").val(""),c.go("browse.artist.overview",{uri:a})):"album"==b?($(document).find(".search-form input").val(""),c.go("browse.album",{uri:a})):"playlist"==b&&($(document).find(".search-form input").val(""),c.go("browse.playlist",{uri:a}))):c.go("search",{query:a})},a.linkingMode=function(a){var b="";return $.isArray(a)||(a=[a]),angular.forEach(a,function(a){""==b&&(c.is(a)?b="active":c.includes(a)&&(b="section"))}),b},a.$on("mopidy:state:online",function(){o.trackEvent("Mopidy","Online"),b.mopidyOnline=!0,h.getCurrentTlTracks().then(function(b){a.currentTracklist=b}),h.getConsume().then(function(a){k.setSetting("mopidyconsume",a)})}),a.$on("mopidy:state:offline",function(){b.mopidyOnline=!1}),a.$on("spotmop:spotify:online",function(){b.spotifyOnline=!0,g.getMe().then(function(b){a.spotifyUser=b,k.setSetting("spotifyuser",a.spotifyUser),o.trackEvent("Spotify","Online",b.id+"("+b.display_name+")"),a.updatePlaylists()})}),m.start(),b.$on("spotmop:pusher:online",function(b,c){var d=k.getSetting("pushername",null);"undefined"!=typeof d&&d&&""!=d||(n.create("initialsetup",a),o.trackEvent("Core","Initial setup"))}),b.$on("spotmop:pusher:received",function(a,b){var c="";b.spotifyuser=JSON.parse(b.spotifyuser),"undefined"!=typeof b.spotifyuser.images&&b.spotifyuser.images.length>0&&(c=b.spotifyuser.images[0].url),l.browserNotify(b.title,b.body,c),o.trackEvent("Pusher","Notification received",b.body)}),b.$on("mopidy:event:trackPlaybackEnded",function(a,b){k.getSetting("echonestenabled",!1)&&i.addToTasteProfile("play",b.tl_track.track.uri)}),h.start(),g.start(),k.getSetting("echonestenabled",!1)&&i.start(),b.shiftKeyHeld=!1,b.ctrlKeyHeld=!1,$("body").bind("keydown",function(a){if(16===a.which?b.shiftKeyHeld=!0:17===a.which&&(b.ctrlKeyHeld=!0),!$(document).find(":focus").is(":input")&&k.getSetting("keyboardShortcutsEnabled",!0)){var c=new Array(46,32,13,37,38,39,40,27);$.inArray(a.which,c)>-1&&a.preventDefault()}}).bind("keyup",function(a){!$(document).find(":focus").is(":input")&&k.getSetting("keyboardShortcutsEnabled",!0)&&(46===a.which&&b.$broadcast("spotmop:keyboardShortcut:delete"),32===a.which&&b.$broadcast("spotmop:keyboardShortcut:space"),13===a.which&&b.$broadcast("spotmop:keyboardShortcut:enter"),37===a.which&&b.$broadcast("spotmop:keyboardShortcut:left"),38===a.which&&b.$broadcast("spotmop:keyboardShortcut:up"),39===a.which&&b.$broadcast("spotmop:keyboardShortcut:right"),40===a.which&&b.$broadcast("spotmop:keyboardShortcut:down"),27===a.which&&(b.$broadcast("spotmop:keyboardShortcut:esc"),r&&(r=!1,$(document).find(".drag-tracer").hide()))),16===a.which&&(b.shiftKeyHeld=!1),17===a.which&&(b.ctrlKeyHeld=!1)}),$(document).on("mouseup","body",function(a){$(a.target).closest(".tracklist").length<=0&&b.$broadcast("spotmop:contextMenu:hide")});var r=!1,s=30;$(document).on("mousedown","body:not(.touchDevice) track, body:not(.touchDevice) tltrack",function(a){var b=$(a.currentTarget).closest(".tracklist"),c=b.find(".track.selected");r={safetyOff:!1,clientX:a.clientX,clientY:a.clientY,tracks:c}}),$(document).on("mouseup",function(b){if("undefined"!=typeof r&&r.safetyOff){$("body").removeClass("dragging"),$(document).find(".droppable").removeClass("dropping"),$(document).find(".drag-hovering").removeClass("drag-hovering");var c=p(b.target),d=q(b.target),e=!1;if(c&&c.closest(".main-menu").length>0&&(e=!0),c){$(document).find(".drag-tracer").html("Dropping...").fadeOut("fast"),$(document).find(".track.drag-hovering").removeClass("drag-hovering");var f=[];if($.each(r.tracks,function(a,b){f.push($(b).attr("data-uri"))}),e&&"queue"===c.attr("data-type"))f.length>10&&l.notify("Adding "+f.length+" track(s) to queue... this could take some time"),h.addToTrackList(f);else if(e&&"library"===c.attr("data-type")){var i=new Array;$.each(f,function(a,b){i.push(g.getFromUri("trackid",b))}),g.addTracksToLibrary(i)}else if(e&&"playlist"===c.attr("data-type"))g.addTracksToPlaylist(c.attr("data-uri"),f);else if(d){var j=1e3,k=0,m=$(d).parent().index();if($.each(r.tracks,function(a,b){$(b).parent().index()<j&&(j=$(b).parent().index()),$(b).parent().index()>k&&(k=$(b).parent().index())}),d.closest(".tracklist").hasClass("queue-items"))m>=k&&(m-=f.length),h.moveTlTracks(j,k+1,m);else if(d.closest(".tracklist").hasClass("playlist-items")){var n=1;k>j&&(n=k-j,n++),a.$broadcast("spotmop:playlist:reorder",j,n,m)}}}else $(document).find(".drag-tracer").fadeOut("medium")}r=!1}),$(document).on("mousemove",function(a){if(r){var b=r.clientX-s,c=r.clientX+s,d=r.clientY-s,e=r.clientY+s;if(a.clientX<b||a.clientX>c||a.clientY<d||a.clientY>e){$("body").addClass("dragging"),$(document).find(".track.drag-hovering").removeClass("drag-hovering");var f=p(a.target),g=q(a.target),h=$(document).find(".drag-tracer");g&&g.addClass("drag-hovering"),r.safetyOff=!0,h.show(),$(document).find(".droppable").removeClass("dropping"),$(document).find(".dropping-within").removeClass("dropping-within");var i=!1;f&&f.closest(".main-menu").length>0&&(i=!0),f&&i&&"queue"===f.attr("data-type")?f.addClass("dropping"):f&&i&&"library"===f.attr("data-type")?f.addClass("dropping"):f&&i&&"playlists"===f.attr("data-type")?(f.closest(".menu-item.playlists").addClass("dropping-within"),f.addClass("dropping")):f&&i&&"playlist"===f.attr("data-type")?(f.addClass("dropping"),f.closest(".menu-item.playlists").addClass("dropping-within")):h.html("Dragging "+r.tracks.length+" track(s)")}}})});